# Книга Джедая

## Содержание

1. [Парсер](#парсер)  
    2.1 [Общие сведения](#общие-сведения)  
    2.2 [Программный интерфейс парсера](#программный-интерфейс-парсера)  
    * [Основные методы](#основные-методы)  
    * [Дополнительные методы](#дополнительные-методы)  
    * [Продвинутые методы](#продвинутые-методы)  
    * [Служебные методы](#служебные-методы)  
    * [Параметры](#параметры)
2. [Плагины](#плагины)
3. [Бакенды](#бакенды)

## Парсер

### Общие сведения

Парсер полностью реализован в виде одной обработки `ПарсерВстроенногоЯзыка.epf`, которая предоставляет три механизма:

* Разбор исходного кода на встроенном языке платформы 1С:Предприятие 8.3 с результатом в виде AST.
* Встроенный механизм обхода AST для плагинов.
* Встроенный механизм замен участков текста в исходнике.

На платформе 1С:Предприятие 8.3 создать экземпляр парсера можно следующим образом:

```bsl
Путь = "C:\git\bsparser\build\ПарсерВстроенногоЯзыка.epf";
Парсер = ВнешниеОбработки.Создать(Путь, Ложь);
```

В скрипте на OneScript создать экземпляр парсера можно следующим образом:

```bsl
ПодключитьСценарий("C:\git\bsparser\src\ПарсерВстроенногоЯзыка\Ext\ObjectModule.bsl", "ПарсерВстроенногоЯзыка");
Парсер = Новый ПарсерВстроенногоЯзыка;
```

Экземпляры плагинов создаются аналогично.

Типичный сценарий работы с плагинами, которые регистрируют ошибки:

```bsl
Плагины = Новый Массив;
Плагины.Добавить(Новый ДетекторНеиспользуемыхПеременных);
Плагины.Добавить(Новый ДетекторПропущенныхТочекСЗапятой);
Парсер.Пуск(Исходник, Плагины);
Для Каждого Ошибка Из Парсер.ТаблицаОшибок() Цикл
    Сообщить(СтрШаблон("%1 [стр: %2; кол: %3]", Ошибка.Текст, Ошибка.НомерСтрокиНачала, Ошибка.НомерКолонкиНачала))
КонецЦикла;
```

Типичный сценарий работы с плагинами, которые генерируют текст:

```bsl
Результаты = ПарсерВстроенногоЯзыка.Пуск(Исходник, Плагин);
Сообщить(СтрСоединить(Результаты));
```

Типичный сценарий работы с плагинами, которые генерируют замены:

```bsl
Плагины = Новый Массив;
Плагины.Добавить(Новый РасстановкаПропущенныхТочекСЗапятой);
Плагины.Добавить(Новый ЗаменаНеканоничныхКлючевыхСлов);
Парсер.Пуск(Исходник, Плагины);
ИсправленныйИсходник = Парсер.ВыполнитьЗамены();
Сообщить(ИсправленныйИсходник);
```

Типичный сценарий работы с бакендом:

```bsl
АСД = Парсер.Разобрать(Исходник);
Текст = Бакенд.Посетить(Парсер, АСД);
Сообщить(Текст);
```

### Программный интерфейс парсера

#### Основные методы

Данные методы составляют основной программный интерфейс для внешней по отношению к парсеру системы. Позволяют выполнить разбор исходного кода, обход AST с плагинами и выполнить модификацию исходного кода по сгенерированным плагинами заменам.

Чаще всего используется метод Пуск(), который заключает в себе типовую последовательность вызовов Разобрать(), Подключить() и Посетить().
Примеры использования данных методов смотрите в скриптах в папке /oscript

* Пуск(Исходник: Строка, Плагины: Массив, Обработка, Параметры: Соответствие, Окружение: Структура): Массив - выполняет разбор исходника в указанном окружении, обход AST с указанными плагинами и указанными параметрами плагинов, возвращает результаты (обычно текстовые) работы плагинов.
* Разобрать(Исходник: Строка, ВнешнееОкружение: Структура): Структура - выполняет разбор исходника в указанном окружении и возвращает AST.
* Подключить(Плагины: Массив, Обработка) - подключает плагины к парсеру.
* Посетить(Модуль: Структура, Параметры: Соответствие) - выполняет обход AST с подключенными плагинами и указанными параметрами плагинов.
* Токенизировать(Исходник: Строка): ТаблицаЗначений - выполняет лексический анализ и возвращает таблицу токенов.
* ВыполнитьЗамены(): Строка - возвращает исходник после выполнения на нем замен участков текста.

#### Дополнительные методы

Данные методы в основном используются в плагинах и вызываются один раз в процедуре Инициализировать(). Методы предоставляют различную вспомогательную информацию и таблицы, в которых плагины могут регистрировать ошибки и замены.

Примеры использования данных методов смотрите в плагинах в папке /plugins

* КлючевыеСлова(): Структура - возвращает перечисление допустимых ключевых слов (например: `КлючевыеСлова.ИначеЕсли`).
* Токены(): Структура - возвращает перечисление допустимых токенов (например: `Токены.ЗнакСложения`).
* Узлы(): Структура - возвращает перечисление допустимых типов узлов AST (например: `Узлы.ОператорПрисваивания`).
* Директивы(): Структура - возвращает перечисление допустимых директив (например: `Директивы.НаСервереБезКонтекста`).
* ИнструкцииПрепроцессора(): Структура - возвращает перечисление допустимых инструкций препроцессора (например: `ИнструкцииПрепроцессора.КонецОбласти`).
* СимволыПрепроцессора(): Структура - возвращает перечисление допустимых символов препроцессора (например: `СимволыПрепроцессора.ТолстыйКлиентОбычноеПриложение`).
* Стек(): Структура - возвращает вершину стека узлов, которая меняется во время обхода AST и позволяет получить текущие родительские узлы в подписках плагинов.
* Счетчики(): Соответствие - возвращает счетчики родительских узлов, которые меня.тся во время обхода AST и позволяет получить количество текущих родительских узлов по типам в подписках плагинов.
* Исходник(): Строка - возвращает текущий исходник.
* ТаблицаТокенов(): ТаблицаЗначений - возвращает текущую таблицу токенов, которая содержит подробную информацию о положении каждого токена в исходном коде. Каждый узел AST содержит индексы первого и последнего своего токена в данной таблице. Например, получить номер первой строки узла можно так: `НомерСтроки = ТаблицаТокенов[Узел.Начало].НомерСтроки`
* ТаблицаЗамен(): ТаблицаЗначений - возвращает текущую таблицу замен, в которой плагины могут регистрировать замены.
* ТаблицаОшибок(): ТаблицаЗначений - возвращает текущую таблицу ошибок, в которой плагины могут регистрировать ошибки.

#### Продвинутые методы

Данные методы позволяют сформировать окружение, в контексте которого будет выполняться разбор исходного кода.

Пример формирования окружения смотрите в скрипте: /oscript/test5.os

Пример формирования глобального окружения смотрите в обработке: /scope/global

* Окружение(ВнешнееОкружение: Структура): Структура - конструктор; возвращает новое окружение.
* ЭлементОкружения(Имя: Строка, Объявление: Структура): Структура - конструктор; возвращает новый элемент окружения.
* ГлобальныйОбъект(Имя: Строка, Доступность: Структура): Структура - конструктор; возвращает новый глобальный объект.
* ГлобальныйМетод(Имя: Строка, ВозвращаетЗначение: Булево, Параметры: Структура, Доступность: Структура): Структура - конструктор; возвращает новый глобальный метод.
* Доступность(Клиент: Булево, ВнешнееСоединение: Булево, МобильноеПриложение: Булево, МобильныйКлиент: Булево, МобильныйСервер: Булево, Сервер: Булево, ТолстыйКлиент: Булево, ТонкийКлиент: Булево, ВебКлиент: Булево, Интеграция: Булево) - конструктор; возвращает новую структуру доступности.

#### Служебные методы

Эти методы позволяют частично установить состояние парсера без выполнения разбора.
Это необходимо при выполнении обхода кэшированных AST, чтобы плагинам была доступна соответствующая информация при инициализации.

* УстановитьИсходник(Исходник: Строка) - устанавливает исходник напрямую без выполнения анализа.
* УстановитьТаблицуТокенов(ТаблицаТокенов: ТаблицаЗначений) - устанавливает таблицу токенов напрямую без выполнения анализа.
* УстановитьТаблицуОшибок(ТаблицаОшибок: ТаблицаЗначений) - устанавливает таблицу ошибок напрямую без выполнения анализа.

#### Параметры

* СтрогийРежим: Булево - определяет поведение парсера при возникновении ошибочных ситуаций.

## Плагины

### Программный интерфейс плагина

Интерфейс плагина состоит из трех постоянных методов и набора методов-подписок.

Например, плагин может подписаться на посещение узла оператора присваивания. В этом случае он должен реализовать экспортный метод `ПосетитьОператорПрисваивания(ОператорПрисваивания)` и вернуть имя этого метода `ПосетитьОператорПрисваивания` в методе `Подписки()`

* Инициализировать(Парсер: Обработка, Параметры: Структура) - вызывается один раз перед обходом AST; позволяет выполнить необходимую инициализацию плагина.
* Закрыть(): Произвольный - вызывается один раз после обхода AST, позволяет плагину "подвести итоги" и вернуть результат своей работы. Некоторые плагины всю работу выполняют в данном методе.
* Подписки(): Массив - вызывается один раз при подключении плагинов. Возвращает список имен процедур-подписок, которые реализует данный плагин.

## Бакенды

Бакенды отличаются от плагинов тем, что не используют общий механизм обхода, а выполняют всю работу сами.

Бакенд должен реализовать один метод:

Посетить(Парсер: Обработка, АСД: Структура): Произвольный - выполняет произвольную работу и возвращает произвольный результат.
